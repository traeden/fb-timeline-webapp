<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== BOOTSTRAP DEBUG ===');
    console.log('bootstrap available:', typeof bootstrap !== 'undefined');
    console.log('jQuery available:', typeof $ !== 'undefined');
    console.log('Bootstrap version:', window.bootstrap?.VERSION || 'Not found');
    console.log('jQuery modal:', typeof $.fn?.modal);
    console.log('======================');
});
</script>



{% extends "bootstrap/base.html" %}
{% block title %}Timeline{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Your Facebook Timeline</h1>
    <div class="d-flex gap-2">
            <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">        
                <i class="fas fa-search"></i> Query Data
            </a>
            <a href="{{ url_for('import_data') }}" class="btn btn-outline-success">
                <i class="fas fa-file-import"></i> Import Data
            </a>
            <a href="{{ url_for('timeline_v2') }}?fetch_comments=yes" class="btn btn-outline-primary">
                <i class="fas fa-comments"></i> Fetch Comments
        </a>
    </div>        
    <!-- Filter Form -->
    <div class="card mb-2">
        <div class="card-body">
            <h5 class="card-title">Filter Posts</h5>
            <form method="GET" action="{{ url_for('timeline_v2') }}" class="row g-3">
                <!-- Preserve API filters as hidden inputs -->
                {% if request.args.get('api_start_date') %}
                    <input type="hidden" name="api_start_date" value="{{ request.args.get('api_start_date') }}">
                {% endif %}
                {% if request.args.get('api_end_date') %}
                    <input type="hidden" name="api_end_date" value="{{ request.args.get('api_end_date') }}">
                {% endif %}
                {% if request.args.get('api_post_type') %}
                    <input type="hidden" name="api_post_type" value="{{ request.args.get('api_post_type') }}">
                {% endif %}
                
                <div class="col-md-3">
                    <label for="display_start_date" class="form-label">Start Date:</label>
                    <input type="date" id="display_start_date" name="display_start_date" class="form-control" value="{{ request.args.get('display_start_date') }}">
                </div>
                <div class="col-md-3">
                    <label for="display_end_date" class="form-label">End Date:</label>
                    <input type="date" id="display_end_date" name="display_end_date" class="form-control" value="{{ request.args.get('display_end_date') }}">
                </div>
                <div class="col-md-3">
                    <label for="keyword" class="form-label">Keyword:</label>
                    <input type="text" id="keyword" name="keyword" class="form-control" value="{{ request.args.get('keyword', '') }}" placeholder="Search in posts...">
                </div>
                <div class="col-md-3">
                    <label for="has_photo" class="form-label">Has Photo:</label>
                    <select id="has_photo" name="has_photo" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_photo') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_photo') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="has_video" class="form-label">Has Video:</label>
                    <select id="has_video" name="has_video" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_video') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_video') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="has_links" class="form-label">Has Links:</label>
                    <select id="has_links" name="has_links" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_links') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_links') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="min_length" class="form-label">Min Length:</label>
                    <input type="number" id="min_length" name="min_length" class="form-control" value="{{ request.args.get('min_length') }}" placeholder="Characters">
                </div>
                <div class="col-md-3">
                    <label for="max_length" class="form-label">Max Length:</label>
                    <input type="number" id="max_length" name="max_length" class="form-control" value="{{ request.args.get('max_length') }}" placeholder="Characters">
                </div>
                <div class="col-md-3">
                    <label for="has_tags" class="form-label">Has Tags (@):</label>
                    <select id="has_tags" name="has_tags" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_tags') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_tags') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <div class="d-flex gap-2 w-100" style="margin-top: 25px;">
                        <button type="submit" class="btn btn-primary flex-fill">Apply Filters</button>
                        <a href="{{ url_for('timeline_v2') }}?clear_filters=true{% if request.args.get('api_start_date') %}&api_start_date={{ request.args.get('api_start_date') }}{% endif %}{% if request.args.get('api_end_date') %}&api_end_date={{ request.args.get('api_end_date') }}{% endif %}{% if request.args.get('api_post_type') %}&api_post_type={{ request.args.get('api_post_type') }}{% endif %}" class="btn btn-secondary flex-fill">Clear Filters</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Applied Filters Section -->
    <div class="mb-4">
        <small class="text-muted">
            <strong>API Filters:</strong> 
            {% if request.args.get('api_start_date') %}Start: {{ request.args.get('api_start_date') }}{% endif %}
            {% if request.args.get('api_end_date') %} | End: {{ request.args.get('api_end_date') }}{% endif %}
            {% if request.args.get('api_post_type') %} | Type: {{ request.args.get('api_post_type')|capitalize }}{% endif %}
            {% if not request.args.get('api_start_date') and not request.args.get('api_end_date') and not request.args.get('api_post_type') %}None{% endif %}
            <br>
            <strong>Display Filters:</strong> 
            {% if request.args.get('display_start_date') %}Start: {{ request.args.get('display_start_date') }}{% endif %}
            {% if request.args.get('display_end_date') %} | End: {{ request.args.get('display_end_date') }}{% endif %}
            {% if request.args.get('keyword') %} | Keyword: "{{ request.args.get('keyword') }}"{% endif %}
            {% if request.args.get('has_photo') %} | Photo: {{ request.args.get('has_photo')|capitalize }}{% endif %}
            {% if request.args.get('has_video') %} | Video: {{ request.args.get('has_video')|capitalize }}{% endif %}
            {% if request.args.get('has_links') %} | Links: {{ request.args.get('has_links')|capitalize }}{% endif %}
            {% if request.args.get('min_length') %} | Min: {{ request.args.get('min_length') }}{% endif %}
            {% if request.args.get('max_length') %} | Max: {{ request.args.get('max_length') }}{% endif %}
            {% if request.args.get('has_tags') %} | Tags: {{ request.args.get('has_tags')|capitalize }}{% endif %}
            {% if not request.args.get('display_start_date') and not request.args.get('display_end_date') and not request.args.get('keyword') and not request.args.get('has_photo') and not request.args.get('has_video') and not request.args.get('has_links') and not request.args.get('min_length') and not request.args.get('max_length') and not request.args.get('has_tags') %}None{% endif %}
        </small>
    </div>

    <!-- Posts Count -->
    <div class="mb-3">
        <strong>{{ posts|length }} posts found</strong>
    </div>

{% if posts %}
    <div class="row">
        {% for post in posts %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <!-- Post Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title mb-0">{{ user_data.name }}</h6>
                                <small class="text-muted">{{ post.created_time }}</small>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                {% if post.comments %}
                                    <span class="badge bg-primary">
                                        <i class="fas fa-comment"></i> {{ post.comments|length }}
                                    </span>
                                {% endif %}
                                <small class="text-muted">ID: {{ post.facebook_id }}</small>
                            </div>
                        </div>

                        <!-- Post Message -->
                        {% if post.message %}
                            <p class="card-text">{{ post.message|safe }}</p>
                        {% endif %}

                        <!-- Media Gallery -->
                        {% if (post.photos and post.photos|length > 0) or (post.videos and post.videos|length > 0) %}                            {% set combined_media = [] %}
                            {% if post.photos %}
                                {% for photo in post.photos %}
                                    {% set _ = combined_media.append({
                                        'type': 'photo',
                                        'src': photo.src,
                                        'alt': 'Photo ' ~ loop.index
                                    }) %}
                                {% endfor %}
                            {% endif %}
                            {% if post.videos %}
                                {% for video in post.videos %}
                                    {% set _ = combined_media.append({
                                        'type': 'video',
                                        'src': video.src if video.src else None,
                                        'thumbnail': video.thumbnail if video.thumbnail else None,
                                        'url': video.url if video.url else None,
                                        'title': video.title if video.title else None,
                                        'alt': 'Video ' ~ loop.index
                                    }) %}
                                {% endfor %}
                            {% endif %}
                            {% set total_media = combined_media|length %}
                            
                            {% if total_media > 0 %}
                                <div class="media-gallery mb-3" 
                                     data-media-count="{{ total_media }}" 
                                     data-post-id="{{ post.facebook_id }}"
                                     data-media-list="{{ combined_media | tojson | safe }}">
                                    
                                    <!-- Visible Media Container -->
                                    <div class="visible-media-container" data-expanded="false">
                                        {% if total_media == 1 %}
                                            <!-- Single media item -->
                                            <div class="media-single">
                                                <div class="media-item" data-media-index="0" data-media-type="{{ combined_media[0].type }}">
                                                    {% if combined_media[0].type == 'photo' %}
                                                        <img src="{{ combined_media[0].src }}" alt="{{ combined_media[0].alt }}" 
                                                             class="media-content" loading="lazy">
                                                    {% else %}
                                                        {% if combined_media[0].src %}
                                                            <video class="media-content" poster="{{ combined_media[0].thumbnail }}" controls preload="metadata">
                                                                <source src="{{ combined_media[0].src }}" type="video/mp4">
                                                            </video>
                                                        {% elif combined_media[0].thumbnail %}
                                                            <div class="video-thumbnail-container">
                                                                <img src="{{ combined_media[0].thumbnail }}" alt="{{ combined_media[0].alt }}" 
                                                                     class="media-content" loading="lazy">
                                                                <div class="video-play-overlay">
                                                                    <i class="fas fa-play"></i>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                            
                                        {% elif total_media == 2 %}
                                            <!-- Two media items -->
                                            <div class="media-grid media-grid-2">
                                                {% for media in combined_media %}
                                                    <div class="media-item" data-media-index="{{ loop.index0 }}" data-media-type="{{ media.type }}">
                                                        {% if media.type == 'photo' %}
                                                            <img src="{{ media.src }}" alt="{{ media.alt }}" 
                                                                 class="media-content" loading="lazy">
                                                        {% else %}
                                                            {% if media.src %}
                                                                <video class="media-content" poster="{{ media.thumbnail }}" controls preload="metadata">
                                                                    <source src="{{ media.src }}" type="video/mp4">
                                                                </video>
                                                            {% elif media.thumbnail %}
                                                                <div class="video-thumbnail-container">
                                                                    <img src="{{ media.thumbnail }}" alt="{{ media.alt }}" 
                                                                         class="media-content" loading="lazy">
                                                                    <div class="video-play-overlay">
                                                                        <i class="fas fa-play"></i>
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                            
                                        {% elif total_media == 3 %}
                                            <!-- Three media items -->
                                            <div class="media-grid media-grid-3">
                                                <div class="media-item media-large" data-media-index="0" data-media-type="{{ combined_media[0].type }}">
                                                    {% if combined_media[0].type == 'photo' %}
                                                        <img src="{{ combined_media[0].src }}" alt="{{ combined_media[0].alt }}" 
                                                             class="media-content" loading="lazy">
                                                    {% else %}
                                                        {% if combined_media[0].src %}
                                                            <video class="media-content" poster="{{ combined_media[0].thumbnail }}" controls preload="metadata">
                                                                <source src="{{ combined_media[0].src }}" type="video/mp4">
                                                            </video>
                                                        {% elif combined_media[0].thumbnail %}
                                                            <div class="video-thumbnail-container">
                                                                <img src="{{ combined_media[0].thumbnail }}" alt="{{ combined_media[0].alt }}" 
                                                                     class="media-content" loading="lazy">
                                                                <div class="video-play-overlay">
                                                                    <i class="fas fa-play"></i>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                                <div class="media-small-container">
                                                    {% for media in combined_media[1:3] %}
                                                        <div class="media-item media-small" data-media-index="{{ loop.index }}" data-media-type="{{ media.type }}">
                                                            {% if media.type == 'photo' %}
                                                                <img src="{{ media.src }}" alt="{{ media.alt }}" 
                                                                     class="media-content" loading="lazy">
                                                            {% else %}
                                                                {% if media.src %}
                                                                    <video class="media-content" poster="{{ media.thumbnail }}" controls preload="metadata">
                                                                        <source src="{{ media.src }}" type="video/mp4">
                                                                    </video>
                                                                {% elif media.thumbnail %}
                                                                    <div class="video-thumbnail-container">
                                                                        <img src="{{ media.thumbnail }}" alt="{{ media.alt }}" 
                                                                             class="media-content" loading="lazy">
                                                                        <div class="video-play-overlay">
                                                                            <i class="fas fa-play"></i>
                                                                        </div>
                                                                    </div>
                                                                {% endif %}
                                                            {% endif %}
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            
                                        {% else %}
                                            <!-- 4+ media items -->
                                            <div class="media-grid media-grid-4">
                                                {% for media in combined_media[:4] %}
                                                    <div class="media-item" data-media-index="{{ loop.index0 }}" data-media-type="{{ media.type }}">
                                                        {% if media.type == 'photo' %}
                                                            <img src="{{ media.src }}" alt="{{ media.alt }}" 
                                                                 class="media-content" loading="lazy">
                                                        {% else %}
                                                            {% if media.src %}
                                                                <video class="media-content" poster="{{ media.thumbnail }}" controls preload="metadata">
                                                                    <source src="{{ media.src }}" type="video/mp4">
                                                                </video>
                                                            {% elif media.thumbnail %}
                                                                <div class="video-thumbnail-container">
                                                                    <img src="{{ media.thumbnail }}" alt="{{ media.alt }}" 
                                                                         class="media-content" loading="lazy">
                                                                    <div class="video-play-overlay">
                                                                        <i class="fas fa-play"></i>
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                        {% if loop.index == 4 and total_media > 4 %}
                                                            <div class="more-overlay">
                                                                <span>+{{ total_media - 4 }}</span>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>

                                    <!-- Hidden Additional Media (for 5+ items) -->
                                    {% if total_media > 4 %}
                                        <div class="additional-media-container" style="display: none;">
                                            <div class="additional-media-grid">
                                                {% for media in combined_media[4:] %}
                                                    <div class="media-item" data-media-index="{{ loop.index0 + 4 }}" data-media-type="{{ media.type }}">
                                                        {% if media.type == 'photo' %}
                                                            <img src="{{ media.src }}" alt="{{ media.alt }}" 
                                                                 class="media-content" loading="lazy">
                                                        {% else %}
                                                            {% if media.src %}
                                                                <video class="media-content" poster="{{ media.thumbnail }}" controls preload="metadata">
                                                                    <source src="{{ media.src }}" type="video/mp4">
                                                                </video>
                                                            {% elif media.thumbnail %}
                                                                <div class="video-thumbnail-container">
                                                                    <img src="{{ media.thumbnail }}" alt="{{ media.alt }}" 
                                                                         class="media-content" loading="lazy">
                                                                    <div class="video-play-overlay">
                                                                        <i class="fas fa-play"></i>
                                                                    </div>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        
                                        <!-- Show/Hide Toggle Button -->
                                        <div class="text-center mt-3">
                                            <button class="btn btn-outline-primary expand-media-btn" data-post-id="{{ post.facebook_id }}">
                                                <span class="expand-text">Show {{ total_media - 4 }} more media</span>
                                                <span class="collapse-text" style="display: none;">Show less</span>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endif %}

                        <!-- Shared Links -->
                        {% if post.links %}
                            <div class="mb-3">
                                {% for link in post.links %}
                                    <div class="card bg-light mb-2">
                                        <div class="row g-0">
                                            {% if link.thumbnail %}
                                                <div class="col-md-4">
                                                    <img src="{{ link.thumbnail }}" class="img-fluid rounded-start h-100" 
                                                         style="object-fit: cover;" alt="Link preview" loading="lazy">
                                                </div>
                                                <div class="col-md-8">
                                            {% else %}
                                                <div class="col-12">
                                            {% endif %}
                                                <div class="card-body">
                                                    {% if link.title %}
                                                        <h6 class="card-title">{{ link.title }}</h6>
                                                    {% endif %}
                                                    {% if link.description %}
                                                        <p class="card-text">{{ link.description }}</p>
                                                    {% endif %}
                                                    {% if link.domain %}
                                                        <small class="text-muted">{{ link.domain }}</small>
                                                    {% endif %}
                                                    {% if link.url %}
                                                        <div class="mt-2">
                                                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-external-link-alt"></i> Visit Link
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}  <!-- MOVED HERE - after the closing </div> for the card -->
                            </div>
                        {% endif %}
                        <!-- Post Comments Section -->
                        {% if post.comments %}
                            <div class="comments-section mt-3">
                                <div class="comments-header mb-2">
                                    <strong class="text-primary">
                                        <i class="fas fa-comments"></i> {{ post.comments|length }} Comment{{ 's' if post.comments|length != 1 else '' }}
                                    </strong>
                                </div>
                                
                                <!-- Visible Comments Container -->
                                <div class="visible-comments-container" data-post-id="{{ post.facebook_id }}" data-expanded="false">
                                    {% for comment in post.comments[:4] %}
                                        <div class="comment-item mb-2 p-2 bg-light rounded">
                                            <div class="comment-header d-flex justify-content-between align-items-start mb-1">
                                                <strong class="comment-author text-primary">{{ comment.from.name }}</strong>
                                                <small class="text-muted">{{ comment.created_time[:10] }}</small>
                                            </div>
                                            <div class="comment-text">{{ comment.message }}</div>
                                            {% if comment.like_count > 0 %}
                                                <small class="text-muted">
                                                    <i class="fas fa-thumbs-up"></i> {{ comment.like_count }}
                                                </small>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Hidden Additional Comments -->
                                {% if post.comments|length > 4 %}
                                    <div class="additional-comments-container" data-post-id="{{ post.facebook_id }}" style="display: none;">
                                        {% for comment in post.comments[4:] %}
                                            <div class="comment-item mb-2 p-2 bg-light rounded">
                                                <div class="comment-header d-flex justify-content-between align-items-start mb-1">
                                                    <strong class="comment-author text-primary">{{ comment.from.name }}</strong>
                                                    <small class="text-muted">{{ comment.created_time[:10] }}</small>
                                                </div>
                                                <div class="comment-text">{{ comment.message }}</div>
                                                {% if comment.like_count > 0 %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-thumbs-up"></i> {{ comment.like_count }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Show/Hide Comments Toggle -->
                                    <div class="text-center mt-2">
                                        <button class="btn btn-outline-secondary btn-sm expand-comments-btn" data-post-id="{{ post.facebook_id }}">
                                            <span class="expand-text">
                                                <i class="fas fa-comment-dots"></i> Show {{ post.comments|length - 4 }} more comment{{ 's' if (post.comments|length - 4) != 1 else '' }}
                                            </span>
                                            <span class="collapse-text" style="display: none;">
                                                <i class="fas fa-chevron-up"></i> Show fewer comments
                                            </span>
                                        </button>
                                    </div>
                                {% endif %}
                                
                                <!-- Refresh Comments Link -->
                                <div class="mt-2">
                                    <a href="{{ url_for('refresh_comments', post_id=post.facebook_id) }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-sync-alt"></i> Refresh Comments
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>                                        
        {% endfor %}
    </div>

    <!-- Media Lightbox Modal -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <div class="media-counter text-white"></div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body d-flex flex-column align-items-center justify-content-center position-relative p-0">
                    <!-- Media Navigation Buttons -->
                    <button class="media-nav-btn prev-btn"onclick="previousMedia()" title="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="media-nav-btn next-btn" onclick="nextMedia()" title="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div id="modalMediaContainer" class="w-100 h-100 d-flex align-items-center justify-content-center"></div>
                                        
                                        <!-- Media-Specific Comments Container -->
                                        <div id="modalCommentsContainer" class="modal-comments-container">
                                            <div class="comments-content">
                                                <div class="comments-header mb-3">
                                                    <h5 class="text-white mb-0">
                                                        <i class="fas fa-comments"></i> Comments on this media
                                                    </h5>
                                                </div>
                                                <div id="mediaCommentsContent" class="media-comments-content">
                                                    <!-- Comments will be populated by JavaScript -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5>No posts found</h5>
        <p class="text-muted">No posts match your current filter criteria.</p>
    </div>
{% endif %}
</div>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<!-- CSS for Improved Media Gallery -->
<style>
/* Base Media Gallery Styles */
.media-gallery {
    margin-bottom: 1rem;
}

.media-item {
    position: relative;
    cursor: pointer;
    border-radius: 12px;
    overflow: hidden;
    background: #f8f9fa;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.media-item:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.media-content {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    border-radius: 12px;
}

/* Single Media Layout */
.media-single {
    display: flex;
    justify-content: center;
    max-width: 600px;
    margin: 0 auto;
}

.media-single .media-item {
    width: 100%;
    aspect-ratio: 16/10;
    max-height: 400px;
}

.media-single .media-content {
    object-fit: contain;
    background: #000;
}

/* Grid Layouts */
.media-grid {
    display: grid;
    border-radius: 12px;
    overflow: hidden;
}

.media-grid-2 {
    grid-template-columns: 1fr 1fr;
    gap: 4px;
    max-height: 400px;
}

.media-grid-2 .media-item {
    aspect-ratio: 1;
}

/* FIXED: 3-item layout to match Facebook */
.media-grid-3 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 4px;
    max-height: 400px;
    max-width: 600px;
    margin: 0 auto;
}

.media-grid-3 .media-large {
    grid-row: 1 / 3;
    grid-column: 1;
}

.media-grid-3 .media-small-container {
    grid-column: 2;
    grid-row: 1 / 3;
    display: grid;
    grid-template-rows: 1fr 1fr;
    gap: 4px;
}

.media-grid-3 .media-small {
    /* No need for aspect-ratio here as it's controlled by the container */
}

/* FIXED: 4-item Grid with proper spacing */
.media-grid-4 {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 4px; /* This is the key fix - adds white space between items */
    max-height: 500px;
    max-width: 600px;
    margin: 0 auto;
}

.media-grid-4 .media-item {
    aspect-ratio: 1;
    min-height: 200px;
    /* Ensure no overlap with clean positioning */
    position: relative;
    z-index: 1;
    /* Ensure items don't have any margin/padding that could cause overlap */
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Ensure proper aspect ratio preservation */
.media-grid-4 .media-content {
    object-fit: cover;
    object-position: center;
}

/* Additional Media Grid (for 5+ items when expanded) */
.additional-media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-top: 16px;
}

.additional-media-grid .media-item {
    aspect-ratio: 4/3;
}

/* Video Specific Styles */
.video-thumbnail-container {
    position: relative;
    width: 100%;
    height: 100%;
}

.video-play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: background 0.2s ease;
    pointer-events: none;
    z-index: 2; /* Ensure play button is above video */
}

.video-play-overlay:hover {
    background: rgba(0, 0, 0, 0.9);
}

/* More Items Overlay */
.more-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    border-radius: 12px;
    z-index: 3; /* Ensure overlay is on top */
}

/* FIXED: Video controls accessibility */
.media-item video {
    position: relative;
    z-index: 2; /* Ensure video controls are accessible */
}

.media-item video::-webkit-media-controls {
    z-index: 3; /* Ensure native controls are on top */
}

/* Expand Button */
.expand-media-btn {
    border-radius: 25px;
    padding: 10px 24px;
    transition: all 0.3s ease;
    font-weight: 500;
}

.expand-media-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Enhanced modal backdrop for dynamic sizing */
.modal-body {
    min-height: auto !important;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

#modalMediaContainer {
    max-width: 90vw;
    max-height: 85vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Ensure modal centers properly */
.modal-dialog {
    margin: auto;
    display: flex;
    align-items: center;
    min-height: calc(100vh - 60px);
}

.modal-content {
    width: auto !important;
    max-width: none !important;
    background: transparent !important;
    border: none !important;
}

/* Enhanced Modal Styles */
.modal-content {
    background: #000 !important;
}

.modal-body {
    min-height: 100vh;
    display: flex !important;
    flex-direction: column !important;
    padding: 0 !important;
}

.modal-media-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    max-width: 90vw;
    max-height: 60vh;
    position: relative;
}

#modalMediaContainer {
    max-width: 90vw;
    max-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Enhanced modal media container with proper aspect ratio handling */
#modalMediaContainer img,
#modalMediaContainer video {
    max-width: 90vw;
    max-height: 85vh;
    object-fit: contain;
    object-position: center;
    border-radius: 8px;
    background: #111;
}

/* Ensure images maintain their aspect ratio in modal */
#modalMediaContainer img {
    width: auto;
    height: auto;
}

.media-counter {
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

/* Fixed container for consistent arrow positioning */
#modalMediaContainer {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 0 auto !important;
}

/* Move navigation arrows to bottom of container */
.media-nav-btn {
    position: fixed !important;
    bottom: 20% !important; /* Position near bottom instead of center */
    transform: none !important; /* Remove the centering transform */
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 1060 !important;
    color: #333;
}

.media-nav-btn:hover {
    background: white;
    transform: scale(1.1); /* Remove translateY from hover since we're not centering */
}

.prev-btn {
    left: 30px !important;
}

.next-btn {
    right: 30px !important;
}

.media-nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Responsive Design */
@media (max-width: 768px) {
    .media-nav-btn {
        width: 40px;
        height: 40px;
        font-size: 1rem;
        bottom: 10% !important; /* Even lower on mobile */
    }
    
    .prev-btn {
        left: 15px !important;
    }
    
    .next-btn {
        right: 15px !important;
    }
}
/* Animation for expanding content */
.additional-media-container {
    animation: fadeInDown 0.3s ease-out;
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
/* Comments Styles */
.comments-section {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.comment-item {
    transition: all 0.2s ease;
}

.comment-item:hover {
    background-color: #e9ecef !important;
}

.comment-author {
    font-size: 0.9rem;
    font-weight: 600;
}

.comment-text {
    font-size: 0.9rem;
    line-height: 1.4;
    margin-top: 2px;
}

.expand-comments-btn {
    border-radius: 20px;
    padding: 8px 16px;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.expand-comments-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.additional-comments-container {
    animation: fadeInDown 0.3s ease-out;
}

.modal-comments-container {
    background: rgba(40, 40, 40, 0.95);
    backdrop-filter: blur(10px);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    max-height: 35vh;
    overflow-y: auto;
    padding: 20px;
    margin-top: auto;
}

.comments-content {
    max-width: 800px;
    margin: 0 auto;
}

.media-comments-content {
    max-height: 25vh;
    overflow-y: auto;
}

.modal-comment-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    border-left: 3px solid #007bff;
}

.modal-comment-author {
    color: #4fc3f7;
    font-weight: 600;
    font-size: 0.9rem;
}

.modal-comment-text {
    color: #e0e0e0;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-top: 5px;
}

.modal-comment-meta {
    color: #999;
    font-size: 0.8rem;
    margin-top: 5px;
}

.media-comments-content::-webkit-scrollbar,
.modal-comments-container::-webkit-scrollbar {
    width: 6px;
}

.media-comments-content::-webkit-scrollbar-track,
.modal-comments-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
}

.media-comments-content::-webkit-scrollbar-thumb,
.modal-comments-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
}
</style>

<!-- Add this script block before your existing JavaScript -->
<script>
// Store media data for each post
window.postMediaData = {};
window.postCommentsData = {};

{% for post in posts %}
    {% if (post.photos and post.photos|length > 0) or (post.videos and post.videos|length > 0) %}
        {% set combined_media = [] %}
        {% if post.photos %}
            {% for photo in post.photos %}
                {% set _ = combined_media.append({
                    'type': 'photo',
                    'src': photo.src,
                    'alt': 'Photo ' ~ loop.index
                }) %}
            {% endfor %}
        {% endif %}
        {% if post.videos %}
            {% for video in post.videos %}
                {% set _ = combined_media.append({
                    'type': 'video',
                    'src': video.src if video.src else None,
                    'thumbnail': video.thumbnail if video.thumbnail else None,
                    'url': video.url if video.url else None,
                    'title': video.title if video.title else None,
                    'alt': 'Video ' ~ loop.index
                }) %}
            {% endfor %}
        {% endif %}
        
        window.postMediaData['{{ post.facebook_id }}'] = {{ combined_media | tojson | safe }};
    {% endif %}

    
    {% if post.comments %}
        window.postCommentsData['{{ post.facebook_id }}'] = {{ post.comments | tojson | safe }};
    {% endif %}
{% endfor %}

</script>

<!-- Modified JavaScript -->
<script>
let currentMediaGallery = [];
let currentMediaIndex = 0;
let currentPostId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize expand/collapse functionality
    initializeExpandButtons();
    initializeCommentsExpandButtons();
    
    // Initialize media item clicks
    initializeMediaClicks();
    
    // Initialize keyboard navigation
    initializeKeyboardNavigation();
});

function initializeExpandButtons() {
    document.querySelectorAll('.expand-media-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const gallery = document.querySelector(`[data-post-id="${postId}"]`);
            const visibleContainer = gallery.querySelector('.visible-media-container');
            const additionalContainer = gallery.querySelector('.additional-media-container');
            const expandText = this.querySelector('.expand-text');
            const collapseText = this.querySelector('.collapse-text');
            
            const isExpanded = visibleContainer.dataset.expanded === 'true';
            
            if (!isExpanded) {
                // Expand
                additionalContainer.style.display = 'block';
                visibleContainer.dataset.expanded = 'true';
                expandText.style.display = 'none';
                collapseText.style.display = 'inline';
                
                // Smooth scroll to new content
                setTimeout(() => {
                    additionalContainer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 150);
            } else {
                // Collapse
                additionalContainer.style.display = 'none';
                visibleContainer.dataset.expanded = 'false';
                expandText.style.display = 'inline';
                collapseText.style.display = 'none';
            }
        });
    });
}

function initializeCommentsExpandButtons() {
    document.querySelectorAll('.expand-comments-btn').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.dataset.postId;
            const visibleContainer = document.querySelector(`.visible-comments-container[data-post-id="${postId}"]`);
            const additionalContainer = document.querySelector(`.additional-comments-container[data-post-id="${postId}"]`);
            const expandText = this.querySelector('.expand-text');
            const collapseText = this.querySelector('.collapse-text');
            
            const isExpanded = visibleContainer.dataset.expanded === 'true';
            
            if (!isExpanded) {
                additionalContainer.style.display = 'block';
                visibleContainer.dataset.expanded = 'true';
                expandText.style.display = 'none';
                collapseText.style.display = 'inline';
                
                setTimeout(() => {
                    additionalContainer.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest' 
                    });
                }, 150);
            } else {
                additionalContainer.style.display = 'none';
                visibleContainer.dataset.expanded = 'false';
                expandText.style.display = 'inline';
                collapseText.style.display = 'none';
            }
        });
    });
}

function updateModalComments() {
    const commentsContainer = document.getElementById('mediaCommentsContent');
    const modalCommentsWrapper = document.getElementById('modalCommentsContainer');
    
    if (!currentPostId || !window.postCommentsData[currentPostId]) {
        modalCommentsWrapper.style.display = 'none';
        return;
    }
    
    const comments = window.postCommentsData[currentPostId];
    modalCommentsWrapper.style.display = 'block';
    
    let commentsHTML = '';
    
    if (comments.length === 0) {
        commentsHTML = '<div class="text-center text-muted"><i class="fas fa-comment-slash"></i> No comments</div>';
    } else {
        const visibleComments = comments.slice(0, 4);
        const hiddenComments = comments.slice(4);
        
        visibleComments.forEach(comment => {
            commentsHTML += createModalCommentHTML(comment);
        });
        
        if (hiddenComments.length > 0) {
            commentsHTML += `
                <div class="text-center mt-3 mb-2">
                    <button class="btn btn-outline-light btn-sm" onclick="toggleModalComments()">
                        <span id="modalExpandText">
                            <i class="fas fa-comment-dots"></i> Show ${hiddenComments.length} more
                        </span>
                        <span id="modalCollapseText" style="display: none;">
                            <i class="fas fa-chevron-up"></i> Show fewer
                        </span>
                    </button>
                </div>
                <div id="modalHiddenComments" style="display: none;">
                    ${hiddenComments.map(comment => createModalCommentHTML(comment)).join('')}
                </div>
            `;
        }
    }
    
    commentsContainer.innerHTML = commentsHTML;
}

function createModalCommentHTML(comment) {
    const likeText = comment.like_count > 0 ? 
        `<div class="modal-comment-meta"><i class="fas fa-thumbs-up"></i> ${comment.like_count}</div>` : '';
    
    return `
        <div class="modal-comment-item">
            <div class="modal-comment-author">${comment.from.name}</div>
            <div class="modal-comment-text">${comment.message}</div>
            <div class="modal-comment-meta">${comment.created_time.substring(0, 10)}</div>
            ${likeText}
        </div>
    `;
}

function toggleModalComments() {
    const hiddenComments = document.getElementById('modalHiddenComments');
    const expandText = document.getElementById('modalExpandText');
    const collapseText = document.getElementById('modalCollapseText');
    
    if (hiddenComments.style.display === 'none') {
        hiddenComments.style.display = 'block';
        expandText.style.display = 'none';
        collapseText.style.display = 'inline';
    } else {
        hiddenComments.style.display = 'none';
        expandText.style.display = 'inline';
        collapseText.style.display = 'none';
    }
}

function initializeMediaClicks() {
    document.querySelectorAll('.media-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Don't open lightbox for more overlay clicks (handle separately)
            if (e.target.closest('.more-overlay')) {
                const gallery = this.closest('.media-gallery');
                const expandBtn = gallery.querySelector('.expand-media-btn');
                if (expandBtn) {
                    expandBtn.click();
                }
                return;
            }
            
            // For videos, check if clicking on actual video element or controls
            const clickedVideo = e.target.closest('video');
            if (clickedVideo) {
                // If clicking on video but not on controls, open lightbox
                const rect = clickedVideo.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                
                // Check if click is in the control bar area (usually bottom 15% of video)
                const controlAreaHeight = rect.height * 0.15;
                const isInControlArea = clickY > (rect.height - controlAreaHeight);
                
                if (!isInControlArea) {
                    // Clicked on video content area, open lightbox
                    e.preventDefault();
                    e.stopPropagation();
                    openLightboxForItem(this);
                    return;
                }
                // Otherwise, let the video handle the click normally
                return;
            }
            
            // For all other media (photos, video thumbnails), open lightbox
            openLightboxForItem(this);
        });
    });
    
    // Handle video play/pause specifically without interfering with lightbox
    document.querySelectorAll('.media-item video').forEach(video => {
        // Pause other videos when one plays
        video.addEventListener('play', function() {
            document.querySelectorAll('video').forEach(otherVideo => {
                if (otherVideo !== this && !otherVideo.paused) {
                    otherVideo.pause();
                }
            });
        });
    });
}

function initializeKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('mediaModal');
        const isModalOpen = modal && (modal.classList.contains('show') || modal.style.display === 'block');
        
        if (isModalOpen) {
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousMedia();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextMedia();
                    break;
                case 'Escape':
                    e.preventDefault();
                    // Try Bootstrap modal close first
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance) {
                            modalInstance.hide();
                        } else {
                            closeManualModal();
                        }
                    } else if (typeof $ !== 'undefined' && $.fn.modal) {
                        $(modal).modal('hide');
                    } else {
                        closeManualModal();
                    }
                    break;
            }
        }
    });
}

// Store container dimensions for each post
window.postContainerSizes = {};

function openLightboxForItem(item) {
    const gallery = item.closest('.media-gallery');
    const postId = gallery.dataset.postId;
    currentPostId = postId;
    const clickedIndex = parseInt(item.dataset.mediaIndex);
    
    // Get media data from the global object instead of parsing from attribute
    if (window.postMediaData && window.postMediaData[postId]) {
        currentMediaGallery = window.postMediaData[postId];
        currentMediaIndex = clickedIndex;
        
        // Calculate optimal container size for this post's media collection
        calculateOptimalContainerSize(postId, () => {
            showLightboxModal();
        });
    } else {
        console.error('No media data found for post:', postId);
    }
}

function calculateOptimalContainerSize(postId, callback) {
    // Check if we already calculated this post's container size
    if (window.postContainerSizes[postId]) {
        callback();
        return;
    }
    
    const mediaItems = window.postMediaData[postId];
    const availableWidth = window.innerWidth * 0.9;
    const availableHeight = window.innerHeight * 0.85;
    
    let maxWidth = 0;
    let maxHeight = 0;
    let loadedCount = 0;
    const totalItems = mediaItems.length;
    
    // Function to check if all items are processed
    const checkComplete = () => {
        loadedCount++;
        if (loadedCount === totalItems) {
            // Store the calculated container size
            window.postContainerSizes[postId] = {
                width: maxWidth,
                height: maxHeight
            };
            callback();
        }
    };
    
    mediaItems.forEach(media => {
        if (media.type === 'photo') {
            const img = new Image();
            img.onload = function() {
                const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                const availableAspectRatio = availableWidth / availableHeight;
                
                let itemWidth, itemHeight;
                
                if (imgAspectRatio > availableAspectRatio) {
                    itemWidth = Math.min(this.naturalWidth, availableWidth);
                    itemHeight = itemWidth / imgAspectRatio;
                } else {
                    itemHeight = Math.min(this.naturalHeight, availableHeight);
                    itemWidth = itemHeight * imgAspectRatio;
                }
                
                maxWidth = Math.max(maxWidth, itemWidth);
                maxHeight = Math.max(maxHeight, itemHeight);
                checkComplete();
            };
            img.onerror = checkComplete;
            img.src = media.src;
            
        } else if (media.type === 'video') {
            if (media.src) {
                const video = document.createElement('video');
                video.addEventListener('loadedmetadata', function() {
                    const videoAspectRatio = this.videoWidth / this.videoHeight;
                    const availableAspectRatio = availableWidth / availableHeight;
                    
                    let itemWidth, itemHeight;
                    
                    if (videoAspectRatio > availableAspectRatio) {
                        itemWidth = Math.min(this.videoWidth, availableWidth);
                        itemHeight = itemWidth / videoAspectRatio;
                    } else {
                        itemHeight = Math.min(this.videoHeight, availableHeight);
                        itemWidth = itemHeight * videoAspectRatio;
                    }
                    
                    maxWidth = Math.max(maxWidth, itemWidth);
                    maxHeight = Math.max(maxHeight, itemHeight);
                    checkComplete();
                });
                video.addEventListener('error', checkComplete);
                video.src = media.src;
                
            } else if (media.thumbnail) {
                const img = new Image();
                img.onload = function() {
                    const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                    const availableAspectRatio = availableWidth / availableHeight;
                    
                    let itemWidth, itemHeight;
                    
                    if (imgAspectRatio > availableAspectRatio) {
                        itemWidth = Math.min(this.naturalWidth, availableWidth);
                        itemHeight = itemWidth / imgAspectRatio;
                    } else {
                        itemHeight = Math.min(this.naturalHeight, availableHeight);
                        itemWidth = itemHeight * imgAspectRatio;
                    }
                    
                    maxWidth = Math.max(maxWidth, itemWidth);
                    maxHeight = Math.max(maxHeight, itemHeight);
                    checkComplete();
                };
                img.onerror = checkComplete;
                img.src = media.thumbnail;
            } else {
                // No media to size, use default
                checkComplete();
            }
        }
    });
}

function showLightboxModal() {
    updateLightboxContent();
    const modalElement = document.getElementById('mediaModal');
    
    // Try multiple Bootstrap approaches
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        // Bootstrap 5
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
        // jQuery Bootstrap (Bootstrap 4 or earlier)
        $(modalElement).modal('show');
    } else {
        // Manual fallback
        console.warn('Bootstrap not available, using manual modal');
        modalElement.classList.add('show');
        modalElement.style.display = 'block';
        modalElement.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'manual-backdrop';
        document.body.appendChild(backdrop);
        
        // Close on backdrop click
        backdrop.addEventListener('click', closeManualModal);
        
        // Close on escape key (already handled by existing keyboard listener)
    }
    
    // Update comments for the current media
    updateModalComments();
}

function closeManualModal() {
    const modalElement = document.getElementById('mediaModal');
    const backdrop = document.getElementById('manual-backdrop');
    
    modalElement.classList.remove('show');
    modalElement.style.display = 'none';
    modalElement.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
    
    if (backdrop) {
        backdrop.remove();
    }
    
    // Pause any playing videos
    const videos = modalElement.querySelectorAll('video');
    videos.forEach(video => {
        if (!video.paused) {
            video.pause();
        }
    });
    
    // Clear the container
    document.getElementById('modalMediaContainer').innerHTML = '';
}

function updateLightboxContent() {
    if (currentMediaGallery.length === 0) return;
    
    const media = currentMediaGallery[currentMediaIndex];
    const container = document.getElementById('modalMediaContainer');
    const counter = document.querySelector('.media-counter');
    const prevBtn = document.querySelector('.prev-btn');
    const nextBtn = document.querySelector('.next-btn');
    
    // Get the current post ID to access the fixed container size
    const galleryElement = document.querySelector('.media-gallery[data-expanded]') || document.querySelector('.media-gallery');
    const postId = galleryElement ? galleryElement.dataset.postId : null;
    const containerSize = postId ? window.postContainerSizes[postId] : null;
    
    // Clear previous content
    container.innerHTML = '';
    
    // Set fixed container size if available
    if (containerSize) {
        container.style.width = containerSize.width + 'px';
        container.style.height = containerSize.height + 'px';
    } else {
        // Fallback to auto sizing
        container.style.width = 'auto';
        container.style.height = 'auto';
    }
    
    // Create media element centered within the fixed container
    if (media.type === 'photo') {
        const img = document.createElement('img');
        img.src = media.src;
        img.alt = media.alt || 'Photo';
        
        // Enhanced image loading with centering within fixed container
        img.onload = function() {
            if (containerSize) {
                // Calculate how to fit this image within the fixed container
                const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                const containerAspectRatio = containerSize.width / containerSize.height;
                
                let finalWidth, finalHeight;
                
                if (imgAspectRatio > containerAspectRatio) {
                    // Image is wider than container - fit by width
                    finalWidth = Math.min(this.naturalWidth, containerSize.width);
                    finalHeight = finalWidth / imgAspectRatio;
                } else {
                    // Image is taller than container - fit by height
                    finalHeight = Math.min(this.naturalHeight, containerSize.height);
                    finalWidth = finalHeight * imgAspectRatio;
                }
                
                this.style.width = finalWidth + 'px';
                this.style.height = finalHeight + 'px';
            } else {
                // Fallback to viewport-based sizing
                const availableWidth = window.innerWidth * 0.9;
                const availableHeight = window.innerHeight * 0.85;
                const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                const availableAspectRatio = availableWidth / availableHeight;
                
                let finalWidth, finalHeight;
                
                if (imgAspectRatio > availableAspectRatio) {
                    finalWidth = Math.min(this.naturalWidth, availableWidth);
                    finalHeight = finalWidth / imgAspectRatio;
                } else {
                    finalHeight = Math.min(this.naturalHeight, availableHeight);
                    finalWidth = finalHeight * imgAspectRatio;
                }
                
                this.style.width = finalWidth + 'px';
                this.style.height = finalHeight + 'px';
                container.style.width = finalWidth + 'px';
                container.style.height = finalHeight + 'px';
            }
            
            // Center the image within the container
            this.style.position = 'absolute';
            this.style.top = '50%';
            this.style.left = '50%';
            this.style.transform = 'translate(-50%, -50%)';
        };
        
        img.onerror = () => {
            container.innerHTML = '<div class="text-white text-center"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Image failed to load</p></div>';
        };
        
        // Apply initial styles
        img.style.borderRadius = '8px';
        img.style.display = 'block';
        img.style.maxWidth = '100%';
        img.style.maxHeight = '100%';
        
        // Create a wrapper for absolute positioning
        const wrapper = document.createElement('div');
        wrapper.style.position = 'relative';
        wrapper.style.width = '100%';
        wrapper.style.height = '100%';
        wrapper.appendChild(img);
        container.appendChild(wrapper);
        
    } else if (media.type === 'video') {
        if (media.src) {
            const video = document.createElement('video');
            video.controls = true;
            video.autoplay = false;
            video.preload = 'metadata';
            
            // Calculate optimal size similar to images
            video.addEventListener('loadedmetadata', function() {
                if (containerSize) {
                    const videoAspectRatio = this.videoWidth / this.videoHeight;
                    const containerAspectRatio = containerSize.width / containerSize.height;
                    
                    let finalWidth, finalHeight;
                    
                    if (videoAspectRatio > containerAspectRatio) {
                        finalWidth = Math.min(this.videoWidth, containerSize.width);
                        finalHeight = finalWidth / videoAspectRatio;
                    } else {
                        finalHeight = Math.min(this.videoHeight, containerSize.height);
                        finalWidth = finalHeight * videoAspectRatio;
                    }
                    
                    this.style.width = finalWidth + 'px';
                    this.style.height = finalHeight + 'px';
                } else {
                    // Fallback sizing
                    const availableWidth = window.innerWidth * 0.9;
                    const availableHeight = window.innerHeight * 0.85;
                    
                    const videoAspectRatio = this.videoWidth / this.videoHeight;
                    const availableAspectRatio = availableWidth / availableHeight;
                    
                    let finalWidth, finalHeight;
                    
                    if (videoAspectRatio > availableAspectRatio) {
                        finalWidth = Math.min(this.videoWidth, availableWidth);
                        finalHeight = finalWidth / videoAspectRatio;
                    } else {
                        finalHeight = Math.min(this.videoHeight, availableHeight);
                        finalWidth = finalHeight * videoAspectRatio;
                    }
                    
                    this.style.width = finalWidth + 'px';
                    this.style.height = finalHeight + 'px';
                    container.style.width = finalWidth + 'px';
                    container.style.height = finalHeight + 'px';
                }
                
                // Center the video
                this.style.position = 'absolute';
                this.style.top = '50%';
                this.style.left = '50%';
                this.style.transform = 'translate(-50%, -50%)';
            });
            
            if (media.thumbnail) {
                video.poster = media.thumbnail;
            }
            
            const source = document.createElement('source');
            source.src = media.src;
            source.type = 'video/mp4';
            video.appendChild(source);
            
            video.onerror = () => {
                container.innerHTML = '<div class="text-white text-center"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Video failed to load</p></div>';
            };
            
            video.style.borderRadius = '8px';
            video.style.display = 'block';
            video.style.maxWidth = '100%';
            video.style.maxHeight = '100%';
            
            // Create wrapper for absolute positioning
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            wrapper.appendChild(video);
            container.appendChild(wrapper);
            
        } else if (media.thumbnail) {
            // Handle video thumbnail case with fixed container
            const img = document.createElement('img');
            img.src = media.thumbnail;
            img.alt = media.alt || 'Video thumbnail';
            
            img.onload = function() {
                if (containerSize) {
                    const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                    const containerAspectRatio = containerSize.width / containerSize.height;
                    
                    let finalWidth, finalHeight;
                    
                    if (imgAspectRatio > containerAspectRatio) {
                        finalWidth = Math.min(this.naturalWidth, containerSize.width);
                        finalHeight = finalWidth / imgAspectRatio;
                    } else {
                        finalHeight = Math.min(this.naturalHeight, containerSize.height);
                        finalWidth = finalHeight * imgAspectRatio;
                    }
                    
                    this.style.width = finalWidth + 'px';
                    this.style.height = finalHeight + 'px';
                } else {
                    // Fallback sizing
                    const availableWidth = window.innerWidth * 0.9;
                    const availableHeight = window.innerHeight * 0.85;
                    const imgAspectRatio = this.naturalWidth / this.naturalHeight;
                    const availableAspectRatio = availableWidth / availableHeight;
                    
                    let finalWidth, finalHeight;
                    
                    if (imgAspectRatio > availableAspectRatio) {
                        finalWidth = Math.min(this.naturalWidth, availableWidth);
                        finalHeight = finalWidth / imgAspectRatio;
                    } else {
                        finalHeight = Math.min(this.naturalHeight, availableHeight);
                        finalWidth = finalHeight * imgAspectRatio;
                    }
                    
                    this.style.width = finalWidth + 'px';
                    this.style.height = finalHeight + 'px';
                    container.style.width = finalWidth + 'px';
                    container.style.height = finalHeight + 'px';
                }
                
                // Center the thumbnail
                this.style.position = 'absolute';
                this.style.top = '50%';
                this.style.left = '50%';
                this.style.transform = 'translate(-50%, -50%)';
            };
            
            img.style.borderRadius = '8px';
            img.style.display = 'block';
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            
            // Add play overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '50%';
            overlay.style.left = '50%';
            overlay.style.transform = 'translate(-50%, -50%)';
            overlay.style.background = 'rgba(0, 0, 0, 0.7)';
            overlay.style.color = 'white';
            overlay.style.width = '80px';
            overlay.style.height = '80px';
            overlay.style.borderRadius = '50%';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.fontSize = '2rem';
            overlay.style.zIndex = '10';
            overlay.innerHTML = '<i class="fas fa-play"></i>';
            
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            wrapper.appendChild(img);
            wrapper.appendChild(overlay);
            
            container.appendChild(wrapper);
        } else {
            container.innerHTML = '<div class="text-white text-center"><i class="fas fa-video fa-3x mb-3"></i><p>Video unavailable</p></div>';
        }
    }
    
    // Update counter
    counter.textContent = `${currentMediaIndex + 1} / ${currentMediaGallery.length}`;
    
    // Update navigation buttons
    prevBtn.disabled = currentMediaIndex === 0;
    nextBtn.disabled = currentMediaIndex === currentMediaGallery.length - 1;
    prevBtn.style.display = currentMediaGallery.length > 1 ? 'flex' : 'none';
    nextBtn.style.display = currentMediaGallery.length > 1 ? 'flex' : 'none';

 // Update comments for the current media
    updateModalComments();        
}

function previousMedia() {
    if (currentMediaIndex > 0) {
        currentMediaIndex--;
        updateLightboxContent();
    }
}

function nextMedia() {
    if (currentMediaIndex < currentMediaGallery.length - 1) {
        currentMediaIndex++;
        updateLightboxContent();
    }
}

// Handle modal cleanup and window resize
document.getElementById('mediaModal').addEventListener('hidden.bs.modal', function() {
    // Pause any playing videos
    const videos = this.querySelectorAll('video');
    videos.forEach(video => {
        if (!video.paused) {
            video.pause();
        }
    });
    
    // Clear the container
    document.getElementById('modalMediaContainer').innerHTML = '';
});

// Handle window resize to adjust image sizes in modal
window.addEventListener('resize', function() {
    const modal = document.getElementById('mediaModal');
    if (modal && modal.classList.contains('show')) {
        // Re-update content to adjust for new viewport size
        setTimeout(updateLightboxContent, 100);
    }
});
</script>
{% endblock %}