{% extends "bootstrap/base.html" %}
{% block title %}Timeline{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Your Facebook Timeline</h1>
    
    <!-- Filter Form -->
    <div class="card mb-2">
        <div class="card-body">
            <h5 class="card-title">Filter Posts</h5>
            <form method="GET" action="{{ url_for('timeline') }}" class="row g-3">
                <!-- Preserve API filters as hidden inputs -->
                {% if request.args.get('api_start_date') %}
                    <input type="hidden" name="api_start_date" value="{{ request.args.get('api_start_date') }}">
                {% endif %}
                {% if request.args.get('api_end_date') %}
                    <input type="hidden" name="api_end_date" value="{{ request.args.get('api_end_date') }}">
                {% endif %}
                {% if request.args.get('api_post_type') %}
                    <input type="hidden" name="api_post_type" value="{{ request.args.get('api_post_type') }}">
                {% endif %}
                
                <div class="col-md-3">
                    <label for="display_start_date" class="form-label">Start Date:</label>
                    <input type="date" id="display_start_date" name="display_start_date" class="form-control" value="{{ request.args.get('display_start_date') }}">
                </div>
                <div class="col-md-3">
                    <label for="display_end_date" class="form-label">End Date:</label>
                    <input type="date" id="display_end_date" name="display_end_date" class="form-control" value="{{ request.args.get('display_end_date') }}">
                </div>
                <div class="col-md-3">
                    <label for="keyword" class="form-label">Keyword:</label>
                    <input type="text" id="keyword" name="keyword" class="form-control" value="{{ request.args.get('keyword', '') }}" placeholder="Search in posts...">
                </div>
                <div class="col-md-3">
                    <label for="has_photo" class="form-label">Has Photo:</label>
                    <select id="has_photo" name="has_photo" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_photo') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_photo') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="has_video" class="form-label">Has Video:</label>
                    <select id="has_video" name="has_video" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_video') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_video') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="min_length" class="form-label">Min Length:</label>
                    <input type="number" id="min_length" name="min_length" class="form-control" value="{{ request.args.get('min_length') }}" placeholder="Characters">
                </div>
                <div class="col-md-3">
                    <label for="max_length" class="form-label">Max Length:</label>
                    <input type="number" id="max_length" name="max_length" class="form-control" value="{{ request.args.get('max_length') }}" placeholder="Characters">
                </div>
                <div class="col-md-3">
                    <label for="has_tags" class="form-label">Has Tags (@):</label>
                    <select id="has_tags" name="has_tags" class="form-control">
                        <option value="">Any</option>
                        <option value="yes" {% if request.args.get('has_tags') == 'yes' %}selected{% endif %}>Yes</option>
                        <option value="no" {% if request.args.get('has_tags') == 'no' %}selected{% endif %}>No</option>
                    </select>
                </div>
                <div class="col-md-3 mt-5 pt-2">
                    <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                    <a href="{{ url_for('timeline') }}?clear_filters=true{% if request.args.get('api_start_date') %}&api_start_date={{ request.args.get('api_start_date') }}{% endif %}{% if request.args.get('api_end_date') %}&api_end_date={{ request.args.get('api_end_date') }}{% endif %}{% if request.args.get('api_post_type') %}&api_post_type={{ request.args.get('api_post_type') }}{% endif %}" class="btn btn-secondary">Clear Filters</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Applied Filters Section -->
    <div class="mb-4">
        <small class="text-muted">
            <strong>API Filters:</strong> 
            {% if request.args.get('api_start_date') %}Start: {{ request.args.get('api_start_date') }}{% endif %}
            {% if request.args.get('api_end_date') %} | End: {{ request.args.get('api_end_date') }}{% endif %}
            {% if request.args.get('api_post_type') %} | Type: {{ request.args.get('api_post_type')|capitalize }}{% endif %}
            {% if not request.args.get('api_start_date') and not request.args.get('api_end_date') and not request.args.get('api_post_type') %}None{% endif %}
            <br>
            <strong>Display Filters:</strong> 
            {% if request.args.get('display_start_date') %}Start: {{ request.args.get('display_start_date') }}{% endif %}
            {% if request.args.get('display_end_date') %} | End: {{ request.args.get('display_end_date') }}{% endif %}
            {% if request.args.get('keyword') %} | Keyword: "{{ request.args.get('keyword') }}"{% endif %}
            {% if request.args.get('has_photo') %} | Photo: {{ request.args.get('has_photo')|capitalize }}{% endif %}
            {% if request.args.get('has_video') %} | Video: {{ request.args.get('has_video')|capitalize }}{% endif %}
            {% if request.args.get('min_length') %} | Min: {{ request.args.get('min_length') }}{% endif %}
            {% if request.args.get('max_length') %} | Max: {{ request.args.get('max_length') }}{% endif %}
            {% if request.args.get('has_tags') %} | Tags: {{ request.args.get('has_tags')|capitalize }}{% endif %}
            {% if not request.args.get('display_start_date') and not request.args.get('display_end_date') and not request.args.get('keyword') and not request.args.get('has_photo') and not request.args.get('has_video') and not request.args.get('min_length') and not request.args.get('max_length') and not request.args.get('has_tags') %}None{% endif %}
        </small>
    </div>

    <!-- Posts Count -->
    <div class="mb-3">
        <strong>{{ posts|length }} posts found</strong>
    </div>

<!-- Enhanced post display section for timeline.html -->
<!-- Replace the existing post display section with this -->

{% if posts %}
    <div class="row">
        {% for post in posts %}
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-body">
                        <!-- Post Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="card-title mb-0">{{ user_data.name }}</h6>
                                <small class="text-muted">{{ post.created_time }}</small>
                            </div>
                            <small class="text-muted">ID: {{ post.facebook_id }}</small>
                        </div>

                        <!-- Post Message -->
                        {% if post.message %}
                            <p class="card-text">{{ post.message|safe }}</p>
                        {% endif %}

                        <!-- Multiple Photos -->
                        {% if post.photos %}
                            <div class="mb-3">
                                {% if post.photos|length == 1 %}
                                    <!-- Single photo -->
                                    <img src="{{ post.photos[0].src }}" alt="Photo" class="img-fluid rounded" style="max-width: 100%; max-height: 400px;">
                                {% elif post.photos|length <= 4 %}
                                    <!-- Photo grid for 2-4 photos -->
                                    <div class="row g-2">
                                        {% for photo in post.photos %}
                                            <div class="col-6">
                                                <img src="{{ photo.src }}" alt="Photo {{ loop.index }}" 
                                                     class="img-fluid rounded w-100" style="height: 200px; object-fit: cover;">
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <!-- Carousel for 5+ photos -->
                                    <div id="carousel-{{ post.facebook_id }}" class="carousel slide" data-bs-ride="carousel">
                                        <div class="carousel-inner">
                                            {% for photo in post.photos %}
                                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                                    <img src="{{ photo.src }}" class="d-block w-100 rounded" 
                                                         style="height: 400px; object-fit: cover;" alt="Photo {{ loop.index }}">
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ post.facebook_id }}" data-bs-slide="prev">
                                            <span class="carousel-control-prev-icon"></span>
                                        </button>
                                        <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ post.facebook_id }}" data-bs-slide="next">
                                            <span class="carousel-control-next-icon"></span>
                                        </button>
                                        <div class="carousel-indicators">
                                            {% for photo in post.photos %}
                                                <button type="button" data-bs-target="#carousel-{{ post.facebook_id }}" 
                                                        data-bs-slide-to="{{ loop.index0 }}" 
                                                        {% if loop.first %}class="active"{% endif %}></button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ post.photos|length }} photos</small>
                                {% endif %}
                            </div>
                        {% endif %}

                        <!-- Videos -->
                        {% if post.videos %}
                            <div class="mb-3">
                                {% for video in post.videos %}
                                    <div class="mb-2">
                                        {% if video.title %}
                                            <h6>{{ video.title }}</h6>
                                        {% endif %}
                                        {% if video.src %}
                                            <video controls class="w-100 rounded" style="max-height: 400px;">
                                                <source src="{{ video.src }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                        {% elif video.url %}
                                            <a href="{{ video.url }}" target="_blank" class="btn btn-outline-primary">
                                                <i class="fas fa-play"></i> Watch Video
                                            </a>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Shared Links -->
                        {% if post.links %}
                            <div class="mb-3">
                                {% for link in post.links %}
                                    <div class="card bg-light mb-2">
                                        <div class="row g-0">
                                            {% if link.thumbnail %}
                                                <div class="col-md-4">
                                                    <img src="{{ link.thumbnail }}" class="img-fluid rounded-start h-100" 
                                                         style="object-fit: cover;" alt="Link preview">
                                                </div>
                                                <div class="col-md-8">
                                            {% else %}
                                                <div class="col-12">
                                            {% endif %}
                                                <div class="card-body">
                                                    {% if link.title %}
                                                        <h6 class="card-title">{{ link.title }}</h6>
                                                    {% endif %}
                                                    {% if link.description %}
                                                        <p class="card-text">{{ link.description }}</p>
                                                    {% endif %}
                                                    {% if link.domain %}
                                                        <small class="text-muted">{{ link.domain }}</small>
                                                    {% endif %}
                                                    {% if link.url %}
                                                        <div class="mt-2">
                                                            <a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-external-link-alt"></i> Visit Link
                                                            </a>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Fallback for backward compatibility -->
                        {% if not post.photos and not post.videos and not post.links %}
                            {% if post.photo_url %}
                                <img src="{{ post.photo_url }}" alt="Photo" class="img-fluid mt-2 rounded" style="max-width: 300px;">
                            {% endif %}
                            {% if post.video_url %}
                                <video controls class="mt-2 rounded" style="max-width: 300px;">
                                    <source src="{{ post.video_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="text-center py-5">
        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
        <h5>No posts found</h5>
        <p class="text-muted">No posts match your current filter criteria.</p>
    </div>
{% endif %}
</div>
{% endblock %}